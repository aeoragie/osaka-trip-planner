<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>오사카 3박 4일 가족 여행 플래너</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Chosen Palette: Warm Harmony -->
    <!-- Application Structure Plan: 이 SPA는 사용자가 여행 일정을 직관적으로 탐색하고 개인화할 수 있도록 설계되었습니다. 핵심 구조는 '탭(Tab)' 기반의 일일 스케줄러이며, 각 카드에는 일정, 식사, 그리고 구체적인 '추천 맛집' 정보가 포함되어 있습니다. 가장 중요한 상호작용 기능인 '교토 여행일 선택' 버튼은 JavaScript를 사용하여 2일차와 3일차의 모든 콘텐츠(일정, 식사, 맛집, 차트)를 동적으로 교체합니다. 새로운 Gemini LLM 기능으로, 각 날짜별로 '유용한 일본어 회화 (Text/TTS)'를 생성하는 기능과 전체 여행 '안전 팁 (Text)' 생성 기능이 추가되어 사용자 편의성을 높입니다. -->
    <!-- Visualization & Content Choices: 1. 여행 일정 및 맛집: 목표(Goal)-정리 및 정보 제공, 표현 방식-아이콘 및 구체적인 식당 이름이 포함된 탭 기반 카드 UI, 상호작용-탭 클릭으로 날짜 전환 및 식당 정보 탐색. / 2. 여행 강도: 목표-정보 제공, 표현 방식-일일 활동량을 나타내는 바 차트(Chart.js), 상호작용-피로도를 시각적으로 빠르게 파악. / 3. 교토 여행일 선택: 목표-비교 및 재구성, 표현 방식-버튼 기반 UI, 상호작용-버튼 클릭 시 JavaScript를 통해 두 날짜의 전체 콘텐츠를 동적으로 교체하며, 차트 ID도 재할당하여 재렌더링. 4. Gemini LLM 통합: 목표-현지 적응 및 안전, 표현 방식-버튼 및 텍스트 출력, 상호작용-버튼 클릭으로 LLM 호출하여 상황별 회화 생성 및 TTS 재생, 전체 안전 팁 생성. 이 모든 선택은 SVG나 Mermaid.js 없이, 순수 HTML/Tailwind와 Canvas 기반 Chart.js를 사용하여 구현되었습니다. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #F8F5F2;
            color: #3D405B;
        }
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        .tab-button.active {
            border-color: #81B29A;
            background-color: #81B29A;
            color: #FFFFFF;
        }
        .plan-card {
            background-color: #FFFFFF;
            border-left: 5px solid #E07A5F;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .plan-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .section-title {
            color: #3D405B;
            font-weight: 700;
            border-bottom: 3px solid #F2CC8F;
            padding-bottom: 0.5rem;
        }
        .option-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: box-shadow 0.3s, transform 0.3s;
        }
        .option-card:hover {
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            transform: translateY(-4px);
        }
        .control-button {
            transition: background-color 0.3s, color 0.3s;
        }
        .food-reco {
            display: block;
            background-color: #F2CC8F;
            color: #3D405B;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.8rem;
            margin-top: 8px;
        }
        .gemini-btn {
            background-color: #5E548E; 
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .gemini-btn:hover {
            background-color: #70679b;
        }
        .gemini-result-box {
            background-color: #E8E5F0;
            border-left: 4px solid #5E548E;
        }
        .tts-audio-control {
            background-color: #fff;
            border-radius: 0.5rem;
            padding: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-[#3D405B]">오사카 3박 4일 가족 여행</h1>
            <p class="text-lg text-gray-600 mt-2">여행과 맛집, 그리고 실시간 도우미까지! 완전한 플래너입니다.</p>
        </header>

        <main>
            <!-- Planner Section -->
            <section id="planner" class="mb-12">
                <h2 class="text-2xl md:text-3xl mb-6 text-center section-title w-fit mx-auto">여행 일정 & 추천 맛집 플래너</h2>
                
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <!-- Tabs -->
                    <div id="tabs" class="flex flex-wrap justify-center border-b-2 border-gray-200 mb-6">
                        <button type="button" data-tab="day1" class="tab-button text-lg font-semibold py-3 px-6 border-b-4 border-transparent hover:bg-gray-100 active">1일차</button>
                        <button type="button" data-tab="day2" class="tab-button text-lg font-semibold py-3 px-6 border-b-4 border-transparent hover:bg-gray-100">2일차</button>
                        <button type="button" data-tab="day3" class="tab-button text-lg font-semibold py-3 px-6 border-b-4 border-transparent hover:bg-gray-100">3일차</button>
                        <button type="button" data-tab="day4" class="tab-button text-lg font-semibold py-3 px-6 border-b-4 border-transparent hover:bg-gray-100">4일차</button>
                    </div>

                    <!-- Tab Content -->
                    <div id="tab-content">
                        <!-- Day 1 -->
                        <div id="day1" class="tab-pane active">
                            <div class="grid md:grid-cols-3 gap-6">
                                <div class="md:col-span-2">
                                    <h3 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-plane-arrival mr-3 text-[#E07A5F]"></i> 1일차: 오사카 도착 & 도톤보리 야경 (18일)</h3>
                                    <div id="day1-schedule" class="space-y-4">
                                        <div class="plan-card p-4 rounded-lg shadow-md">
                                            <p class="font-bold text-lg"><i class="far fa-clock mr-2"></i>오후 2:00</p>
                                            <p>인천 국제공항 출발 (기내식 또는 공항에서 점심 해결)</p>
                                        </div>
                                        <div class="plan-card p-4 rounded-lg shadow-md">
                                            <p class="font-bold text-lg"><i class="far fa-clock mr-2"></i>오후 4:00</p>
                                            <p>간사이 국제공항 도착 후 난바역 숙소로 이동</p>
                                        </div>
                                        <div class="plan-card p-4 rounded-lg shadow-md">
                                            <p class="font-bold text-lg"><i class="far fa-clock mr-2"></i>오후 7:00</p>
                                            <p>도톤보리 저녁 식사 및 탐방</p>
                                            <p class="text-sm text-gray-600 mt-1">팁: 글리코상 간판 앞에서 가족사진은 필수! 유명한 타코야끼나 오코노미야끼 줄이 길 수 있습니다.</p>
                                            <span class="food-reco"><i class="fas fa-utensils mr-1"></i> 추천 저녁: **오코노미야끼 미즈노** 또는 **이치란 라멘 도톤보리 본점**. (구글맵 검색 추천)</span>
                                        </div>
                                    </div>
                                    <!-- Gemini Integration for Day 1 -->
                                    <div class="mt-6 p-4 gemini-result-box rounded-lg">
                                        <button type="button" onclick="handlePhraseGeneration('day1', 'Osaka', '도톤보리에서 식사 주문 시 사용할 일본어 회화 3가지')" class="gemini-btn text-sm"><i class="fas fa-microphone mr-2"></i>✨ 오사카 회화 듣기</button>
                                        <div id="phraseResult-day1" class="mt-3 text-gray-700"></div>
                                        <div id="audioContainer-day1" class="mt-2 tts-audio-control hidden">
                                            <p class="text-xs text-gray-500 mb-1">일본어 음성 재생:</p>
                                            <audio controls class="w-full"></audio>
                                        </div>
                                    </div>
                                </div>
                                <div class="md:col-span-1">
                                    <div class="chart-container relative h-80 w-full max-w-sm mx-auto p-4 bg-gray-50 rounded-lg">
                                        <canvas id="day1Chart"></canvas>
                                    </div>
                                    <div class="mt-4 p-4 bg-[#F2CC8F] bg-opacity-30 rounded-lg text-center">
                                        <h4 class="font-bold text-lg">1일차 요약</h4>
                                        <p class="mt-1">공항 이동과 저녁 시간의 짧은 탐방으로 여유롭게 시작하는 날입니다.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Day 2 -->
                        <div id="day2" class="tab-pane hidden">
                            <!-- This content will be swapped by JS -->
                        </div>
                        <!-- Day 3 -->
                        <div id="day3" class="tab-pane hidden">
                            <!-- This content will be swapped by JS -->
                        </div>
                        <!-- Day 4 -->
                        <div id="day4" class="tab-pane hidden">
                             <div class="grid md:grid-cols-3 gap-6">
                                <div class="md:col-span-2">
                                    <h3 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-plane-departure mr-3 text-[#E07A5F]"></i> 4일차: 마지막 식사 & 귀국 (21일)</h3>
                                    <div class="space-y-4">
                                        <div class="plan-card p-4 rounded-lg shadow-md">
                                            <p class="font-bold text-lg"><i class="far fa-clock mr-2"></i>오전 9:00</p>
                                            <p>구로몬 시장 아침 식사 및 구경</p>
                                             <p class="text-sm text-gray-600 mt-1">팁: 오사카의 부엌. 신선한 해산물을 맛보거나 아침 식사를 해결하기 좋습니다.</p>
                                             <span class="food-reco"><i class="fas fa-utensils mr-1"></i> 추천 아침: **구로몬 시장** 내 신선한 **스시/참치 덮밥** 또는 **어묵**.</span>
                                        </div>
                                        <div class="plan-card p-4 rounded-lg shadow-md">
                                            <p class="font-bold text-lg"><i class="far fa-clock mr-2"></i>오전 11:00</p>
                                            <p>숙소 복귀 후 짐 정리 및 체크아웃</p>
                                        </div>
                                        <div class="plan-card p-4 rounded-lg shadow-md">
                                            <p class="font-bold text-lg"><i class="far fa-clock mr-2"></i>오후 12:30</p>
                                            <p>난바역 또는 공항에서 점심 식사 후 간사이 공항으로 이동</p>
                                            <span class="food-reco"><i class="fas fa-utensils mr-1"></i> 추천 점심: **간사이 공항** 내 식당가 (간단식) 또는 **난바역** 주변 **규카츠**.</span>
                                        </div>
                                        <div class="plan-card p-4 rounded-lg shadow-md">
                                            <p class="font-bold text-lg"><i class="far fa-clock mr-2"></i>오후 4:00</p>
                                            <p>간사이 국제공항 출발, 한국으로</p>
                                        </div>
                                    </div>
                                    <!-- Gemini Integration for Day 4 -->
                                    <div class="mt-6 p-4 gemini-result-box rounded-lg">
                                        <button type="button" onclick="handlePhraseGeneration('day4', 'Osaka', '구로몬 시장에서 사용할 일본어 회화 3가지. 가격 흥정, 위치 문의 등')" class="gemini-btn text-sm"><i class="fas fa-microphone mr-2"></i>✨ 오사카 회화 듣기</button>
                                        <div id="phraseResult-day4" class="mt-3 text-gray-700"></div>
                                        <div id="audioContainer-day4" class="mt-2 tts-audio-control hidden">
                                            <p class="text-xs text-gray-500 mb-1">일본어 음성 재생:</p>
                                            <audio controls class="w-full"></audio>
                                        </div>
                                    </div>
                                </div>
                                <div class="md:col-span-1">
                                     <div class="chart-container relative h-80 w-full max-w-sm mx-auto p-4 bg-gray-50 rounded-lg">
                                        <canvas id="day4Chart"></canvas>
                                    </div>
                                    <div class="mt-4 p-4 bg-[#F2CC8F] bg-opacity-30 rounded-lg text-center">
                                        <h4 class="font-bold text-lg">4일차 요약</h4>
                                        <p class="mt-1">오전 시장 탐방 후 공항으로 이동하는 마무리 일정입니다.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Gemini Safety & Tips Section -->
            <section id="gemini-tips" class="mb-12 text-center bg-white p-6 rounded-2xl shadow-lg">
                 <h2 class="text-2xl md:text-3xl mb-4 section-title w-fit mx-auto">Gemini 여행 도우미</h2>
                 <p class="text-gray-600 mb-6">오사카, 교토, 가족 여행을 위한 맞춤형 팁과 안전 수칙을 확인하세요.</p>
                 <button type="button" id="generateTipsBtn" onclick="generateSafetyTips()" class="gemini-btn mb-4"><i class="fas fa-shield-alt mr-2"></i>✨ 긴급 상황 대비 팁 받기</button>
                 <div id="tipsResult" class="mt-4 p-4 gemini-result-box rounded-lg text-left hidden">
                    <p class="font-bold text-lg mb-2 text-[#5E548E]">✅ 맞춤 여행 팁:</p>
                    <div id="tipsContent" class="space-y-3">
                        <div class="flex justify-center items-center h-20">
                            <i class="fas fa-spinner fa-spin text-[#5E548E]"></i>
                        </div>
                    </div>
                 </div>
            </section>

            <!-- Interactive Control Section -->
            <section id="interactive-control" class="mb-12 text-center bg-white p-6 rounded-2xl shadow-lg">
                 <h2 class="text-2xl md:text-3xl mb-4 section-title w-fit mx-auto">나만의 일정 만들기</h2>
                 <p class="text-gray-600 mb-6">교토 당일치기 여행은 언제가 좋을까요? 아래 버튼으로 2일차와 3일차 일정을 바꿔보세요. (식당 추천도 함께 변경됩니다)</p>
                 <div class="flex justify-center gap-4">
                     <button type="button" id="setKyotoDay2" class="control-button py-2 px-5 bg-[#81B29A] text-white font-semibold rounded-lg shadow-md hover:bg-[#6a9a81]">교토 여행 2일차에 하기</button>
                     <button type="button" id="setKyotoDay3" class="control-button py-2 px-5 bg-gray-300 text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-400">교토 여행 3일차에 하기</button>
                 </div>
            </section>

            <!-- Recommendations Section -->
            <section id="recommendations">
                <h2 class="text-2xl md:text-3xl mb-6 text-center section-title w-fit mx-auto">추가 여행지 둘러보기</h2>
                <p class="text-center text-gray-600 mb-8">기본 일정 외에 고려할 수 있는 오사카, 고베, 제미니 추천 코스입니다.</p>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Osaka Must-visits -->
                    <div class="option-card p-5">
                        <h3 class="text-xl font-bold mb-3 text-[#3D405B]"><i class="fas fa-star mr-2 text-yellow-500"></i>오사카 필수 코스</h3>
                        <ul class="list-disc list-inside space-y-2 text-gray-700">
                            <li><strong>유니버설 스튜디오 재팬 (USJ):</strong> 하루 전체를 투자해야 하는 곳. 가족 모두에게 최고의 만족도를 줄 수 있습니다.</li>
                            <li><strong>오사카 수족관 (가이유칸):</strong> 세계적인 규모의 수족관. 덴포잔 대관람차와 묶어 일정을 짜면 좋습니다.</li>
                            <li><strong>오사카 성:</strong> 역사에 관심 있는 가족에게 추천.</li>
                        </ul>
                    </div>
                    <!-- Gemini's Picks -->
                    <div class="option-card p-5">
                        <h3 class="text-xl font-bold mb-3 text-[#3D405B]"><i class="fas fa-lightbulb mr-2 text-blue-500"></i>Gemini 추천 코스</h3>
                        <ul class="list-disc list-inside space-y-2 text-gray-700">
                            <li><strong>컵누들 박물관 (이케다):</strong> 나만의 컵라면 만들기 체험. 아이들이 있다면 적극 추천합니다.</li>
                            <li><strong>나카자키쵸 카페 거리:</strong> 고즈넉하고 개성 있는 카페들이 많아 휴식이나 사진 찍기에 좋습니다.</li>
                        </ul>
                    </div>
                    <!-- Kobe Option -->
                    <div class="option-card p-5">
                        <h3 class="text-xl font-bold mb-3 text-[#3D405B]"><i class="fas fa-anchor mr-2 text-red-500"></i>고베 당일치기 (대안)</h3>
                         <ul class="list-disc list-inside space-y-2 text-gray-700">
                            <li><strong>고베 하버랜드:</strong> 세련된 야경과 쇼핑, 식사를 즐길 수 있는 항구.</li>
                            <li><strong>기타노이진칸:</strong> 유럽풍의 이국적인 거리.</li>
                            <li><strong>고베규:</strong> 예산이 허락한다면, 고베에서 세계적인 소고기 요리를 경험해 보세요.</li>
                        </ul>
                    </div>
                </div>
            </section>
        </main>

        <footer class="text-center mt-12 py-6 border-t border-gray-300">
            <p class="text-gray-500">맛집 정보는 현지 상황에 따라 변동될 수 있으므로, 출발 전 구글 지도에서 다시 한 번 확인해 주세요.</p>
        </footer>
    </div>

    <!-- Template for Osaka Day -->
    <template id="osaka-day-template">
        <div class="grid md:grid-cols-3 gap-6">
            <div class="md:col-span-2">
                <h3 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-city mr-3 text-[#E07A5F]"></i> 오사카 핵심 완전 정복</h3>
                <div class="space-y-4">
                    <div class="plan-card p-4 rounded-lg shadow-md">
                        <p class="font-bold text-lg"><i class="far fa-clock mr-2"></i>오전 8:30</p>
                        <p>숙소 근처에서 간단한 아침 식사 후 오사카 성으로 이동</p>
                         <span class="food-reco"><i class="fas fa-coffee mr-1"></i> 추천 아침: 숙소 근처 **편의점 (로손/패밀리마트)** 또는 **도토루 커피**.</span>
                    </div>
                    <div class="plan-card p-4 rounded-lg shadow-md">
                        <p class="font-bold text-lg"><i class="far fa-clock mr-2"></i>오전 9:30</p>
                        <p>오사카 성 공원 산책 및 천수각 관람</p>
                    </div>
                    <div class="plan-card p-4 rounded-lg shadow-md">
                        <p class="font-bold text-lg"><i class="far fa-clock mr-2"></i>오후 1:00</p>
                        <p>신세카이 지역으로 이동하여 점심 식사</p>
                        <p class="text-sm text-gray-600 mt-1">팁: 츠텐카쿠 타워 근처 복고풍 거리에서 쿠시카츠를 맛보세요.</p>
                        <span class="food-reco"><i class="fas fa-hotdog mr-1"></i> 추천 점심: **쿠시카츠 다루마 신세카이 본점**. (튀김 꼬치)</span>
                    </div>
                    <div class="plan-card p-4 rounded-lg shadow-md">
                        <p class="font-bold text-lg"><i class="far fa-clock mr-2"></i>오후 3:30</p>
                        <p>우메다 스카이 빌딩 공중정원에서 도시 전경 감상</p>
                    </div>
                    <div class="plan-card p-4 rounded-lg shadow-md">
                        <p class="font-bold text-lg"><i class="far fa-clock mr-2"></i>오후 7:00</p>
                        <p>우메다 또는 난바로 돌아와 저녁 식사 및 쇼핑</p>
                        <span class="food-reco"><i class="fas fa-drumstick-bite mr-1"></i> 추천 저녁: **야키니쿠 M (난바)** 또는 **백화점 식당가**. (가족이 편안하게 식사하기 좋습니다)</span>
                    </div>
                </div>
                <!-- Gemini Integration for Osaka Day -->
                <div class="mt-6 p-4 gemini-result-box rounded-lg">
                    <button type="button" onclick="handlePhraseGeneration('osakaDay', 'Osaka', '쿠시카츠 가게에서 주문 및 결제 시 사용할 일본어 회화 3가지')" class="gemini-btn text-sm"><i class="fas fa-microphone mr-2"></i>✨ 오사카 회화 듣기</button>
                    <div id="phraseResult-osakaDay" class="mt-3 text-gray-700"></div>
                    <div id="audioContainer-osakaDay" class="mt-2 tts-audio-control hidden">
                        <p class="text-xs text-gray-500 mb-1">일본어 음성 재생:</p>
                        <audio controls class="w-full"></audio>
                    </div>
                </div>
            </div>
            <div class="md:col-span-1">
                <div class="chart-container relative h-80 w-full max-w-sm mx-auto p-4 bg-gray-50 rounded-lg">
                    <canvas id="osakaDayChart"></canvas>
                </div>
                <div class="mt-4 p-4 bg-[#F2CC8F] bg-opacity-30 rounded-lg text-center">
                    <h4 class="font-bold text-lg">오사카 데이 요약</h4>
                    <p class="mt-1">오사카의 주요 명소를 둘러보는 활동적인 하루입니다. 이동 거리가 길 수 있습니다.</p>
                </div>
            </div>
        </div>
    </template>

    <!-- Template for Kyoto Day -->
    <template id="kyoto-day-template">
        <div class="grid md:grid-cols-3 gap-6">
            <div class="md:col-span-2">
                <h3 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-torii-gate mr-3 text-[#E07A5F]"></i> 교토 당일치기 여행</h3>
                <div class="space-y-4">
                     <div class="plan-card p-4 rounded-lg shadow-md">
                        <p class="font-bold text-lg"><i class="far fa-clock mr-2"></i>오전 8:30</p>
                        <p>난바에서 교토로 이동 (이동 중 간단한 아침 식사)</p>
                        <span class="food-reco"><i class="fas fa-train mr-1"></i> 추천 아침: 난바역 **JR/사철 역사 내** 베이커리 또는 편의점.</span>
                    </div>
                    <div class="plan-card p-4 rounded-lg shadow-md">
                        <p class="font-bold text-lg"><i class="far fa-clock mr-2"></i>오전 10:00</p>
                        <p>후시미 이나리 신사 (붉은 토리이 길) 방문</p>
                        <p class="text-sm text-gray-600 mt-1">팁: 계단이 많으므로 편한 복장과 신발이 필수입니다.</p>
                    </div>
                    <div class="plan-card p-4 rounded-lg shadow-md">
                        <p class="font-bold text-lg"><i class="far fa-clock mr-2"></i>오후 1:00</p>
                        <p>기온 거리 또는 청수사 주변에서 점심 식사</p>
                         <p class="text-sm text-gray-600 mt-1">팁: 교토 특유의 분위기를 즐길 수 있는 전통 요리를 시도해 보세요.</p>
                         <span class="food-reco"><i class="fas fa-leaf mr-1"></i> 추천 점심: **오멘 고다이지점** (교토식 우동) 또는 **유도후** (두부 요리 전문점).</span>
                    </div>
                    <div class="plan-card p-4 rounded-lg shadow-md">
                        <p class="font-bold text-lg"><i class="far fa-clock mr-2"></i>오후 3:30</p>
                        <p>기요미즈데라 (청수사) 관람 및 산넨자카/니넨자카 거리 탐방</p>
                    </div>
                    <div class="plan-card p-4 rounded-lg shadow-md">
                        <p class="font-bold text-lg"><i class="far fa-clock mr-2"></i>오후 6:00</p>
                        <p>교토역 또는 오사카 난바 복귀 후 저녁 식사</p>
                        <span class="food-reco"><i class="fas fa-fish mr-1"></i> 추천 저녁: **무사시 스시 (회전 초밥)** 또는 **긴자 바이린 (돈까스)**.</span>
                    </div>
                </div>
                <!-- Gemini Integration for Kyoto Day -->
                <div class="mt-6 p-4 gemini-result-box rounded-lg">
                    <button type="button" onclick="handlePhraseGeneration('kyotoDay', 'Kyoto', '후시미이나리 신사에서 길을 묻거나 기념품 구매 시 사용할 일본어 회화 3가지')" class="gemini-btn text-sm"><i class="fas fa-microphone mr-2"></i>✨ 교토 회화 듣기</button>
                    <div id="phraseResult-kyotoDay" class="mt-3 text-gray-700"></div>
                    <div id="audioContainer-kyotoDay" class="mt-2 tts-audio-control hidden">
                        <p class="text-xs text-gray-500 mb-1">일본어 음성 재생:</p>
                        <audio controls class="w-full"></audio>
                    </div>
                </div>
            </div>
            <div class="md:col-span-1">
                 <div class="chart-container relative h-80 w-full max-w-sm mx-auto p-4 bg-gray-50 rounded-lg">
                    <canvas id="kyotoDayChart"></canvas>
                </div>
                <div class="mt-4 p-4 bg-[#F2CC8F] bg-opacity-30 rounded-lg text-center">
                    <h4 class="font-bold text-lg">교토 데이 요약</h4>
                    <p class="mt-1">가장 활동 강도가 높은 날입니다. 이동 시간과 걷는 시간이 길어 체력 안배가 가장 중요합니다.</p>
                </div>
            </div>
        </div>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tabs = document.querySelectorAll('.tab-button');
            const panes = document.querySelectorAll('.tab-pane');
            const day2Content = document.getElementById('day2');
            const day3Content = document.getElementById('day3');
            const osakaTemplate = document.getElementById('osaka-day-template');
            const kyotoTemplate = document.getElementById('kyoto-day-template');
            const setKyotoDay2Btn = document.getElementById('setKyotoDay2');
            const setKyotoDay3Btn = document.getElementById('setKyotoDay3');
            const generateTipsBtn = document.getElementById('generateTipsBtn');

            let charts = {};
            let isKyotoOnDay2 = true;

            const chartData = {
                day1: { label: '이동 및 적응', value: 3 },
                osaka: { label: '도시 탐험', value: 8 },
                kyoto: { label: '교토 원정', value: 10 },
                day4: { label: '마무리 및 귀국', value: 4 }
            };
            
            function createChart(canvasId, label, dataValue) {
                const existingCanvas = document.getElementById(canvasId);
                if (!existingCanvas) return; 

                if (charts[canvasId]) {
                    charts[canvasId].destroy();
                }
                const ctx = existingCanvas.getContext('2d');
                charts[canvasId] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [label],
                        datasets: [{
                            label: '여행 강도 (10점 만점)',
                            data: [dataValue],
                            backgroundColor: ['#81B29A'],
                            borderColor: ['#6a9a81'],
                            borderWidth: 1,
                            borderRadius: 5,
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: true,
                                max: 10,
                                grid: { display: false }
                            },
                            y: {
                                grid: { display: false }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: '일일 활동 강도' }
                        }
                    }
                });
            }
            
            function updateSchedule(kyotoIsDay2) {
                isKyotoOnDay2 = kyotoIsDay2;

                // Destroy existing charts to prevent memory leaks and ID conflicts
                if (charts['day2ChartCanvas']) charts['day2ChartCanvas'].destroy();
                if (charts['day3ChartCanvas']) charts['day3ChartCanvas'].destroy();

                day2Content.innerHTML = '';
                day3Content.innerHTML = '';

                const kyotoNode = kyotoTemplate.content.cloneNode(true);
                const osakaNode = osakaTemplate.content.cloneNode(true);

                const kyotoCanvas = kyotoNode.querySelector('canvas');
                const osakaCanvas = osakaNode.querySelector('canvas');

                if (kyotoIsDay2) {
                    kyotoCanvas.id = 'day2ChartCanvas'; 
                    osakaCanvas.id = 'day3ChartCanvas';
                    day2Content.appendChild(kyotoNode);
                    day3Content.appendChild(osakaNode);
                    
                    setKyotoDay2Btn.classList.add('bg-[#81B29A]', 'text-white');
                    setKyotoDay2Btn.classList.remove('bg-gray-300', 'text-gray-700');
                    setKyotoDay3Btn.classList.add('bg-gray-300', 'text-gray-700');
                    setKyotoDay3Btn.classList.remove('bg-[#81B29A]', 'text-white');
                } else {
                    osakaCanvas.id = 'day2ChartCanvas'; 
                    kyotoCanvas.id = 'day3ChartCanvas';
                    day2Content.appendChild(osakaNode);
                    day3Content.appendChild(kyotoNode);
                    
                    setKyotoDay3Btn.classList.add('bg-[#81B29A]', 'text-white');
                    setKyotoDay3Btn.classList.remove('bg-gray-300', 'text-gray-700');
                    setKyotoDay2Btn.classList.add('bg-gray-300', 'text-gray-700');
                    setKyotoDay2Btn.classList.remove('bg-[#81B29A]', 'text-white');
                }
                 
                createChart('day2ChartCanvas', kyotoIsDay2 ? chartData.kyoto.label : chartData.osaka.label, kyotoIsDay2 ? chartData.kyoto.value : chartData.osaka.value);
                createChart('day3ChartCanvas', kyotoIsDay2 ? chartData.osaka.label : chartData.kyoto.label, kyotoIsDay2 ? chartData.osaka.value : chartData.kyoto.value);
                
                // Static charts
                createChart('day1Chart', chartData.day1.label, chartData.day1.value);
                createChart('day4Chart', chartData.day4.label, chartData.day4.value);
            }

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(item => item.classList.remove('active'));
                    tab.classList.add('active');

                    panes.forEach(pane => {
                        pane.classList.add('hidden');
                    });
                    document.getElementById(tab.dataset.tab).classList.remove('hidden');
                });
            });

            setKyotoDay2Btn.addEventListener('click', () => {
                if (!isKyotoOnDay2) updateSchedule(true);
            });

            setKyotoDay3Btn.addEventListener('click', () => {
                if (isKyotoOnDay2) updateSchedule(false);
            });
            
            // --- Gemini API Functions Start ---

            function base64ToArrayBuffer(base64) {
                const binaryString = atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            }

            function pcmToWav(pcmData, sampleRate) {
                const numChannels = 1;
                const bytesPerSample = 2; 
                const blockAlign = numChannels * bytesPerSample;
                const byteRate = sampleRate * blockAlign;
                const dataSize = pcmData.length * bytesPerSample;

                const buffer = new ArrayBuffer(44 + dataSize);
                const view = new DataView(buffer);

                writeString(view, 0, 'RIFF');
                view.setUint32(4, 36 + dataSize, true);
                writeString(view, 8, 'WAVE');
                writeString(view, 12, 'fmt ');
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true); 
                view.setUint16(22, numChannels, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, byteRate, true);
                view.setUint16(32, blockAlign, true);
                view.setUint16(34, bytesPerSample * 8, true);
                writeString(view, 36, 'data');
                view.setUint32(40, dataSize, true);

                let offset = 44;
                for (let i = 0; i < pcmData.length; i++) {
                    view.setInt16(offset, pcmData[i], true);
                    offset += bytesPerSample;
                }

                return new Blob([view], { type: 'audio/wav' });
            }

            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            const apiKey = ""; 
            const LLM_MODEL = "gemini-2.5-flash-preview-05-20";
            const TTS_MODEL = "gemini-2.5-flash-preview-tts";

            async function fetchWithBackoff(url, options, maxRetries = 5) {
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (response.status === 429 && i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        if (!response.ok) {
                            const errorBody = await response.text();
                            throw new Error(`API call failed with status ${response.status}: ${errorBody}`);
                        }
                        return response.json();
                    } catch (error) {
                        if (i === maxRetries - 1) throw error;
                    }
                }
            }

            async function fetchText(prompt, systemPrompt) {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };
                
                const result = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                return result.candidates?.[0]?.content?.parts?.[0]?.text || "텍스트 생성에 실패했습니다.";
            }

            async function fetchAudio(text) {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: text }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Kore" } 
                            }
                        }
                    },
                };

                const result = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    return URL.createObjectURL(wavBlob);
                }
                throw new Error("오디오 데이터 생성 실패.");
            }

            async function handlePhraseGeneration(dayId, location, context) {
                const resultDiv = document.getElementById(`phraseResult-${dayId}`);
                const audioContainer = document.getElementById(`audioContainer-${dayId}`);
                const audioEl = audioContainer.querySelector('audio');
                const button = resultDiv.previousElementSibling;

                resultDiv.innerHTML = '<div class="flex items-center text-[#5E548E]"><i class="fas fa-spinner fa-spin mr-2"></i> 회화 생성 중...</div>';
                audioContainer.classList.add('hidden');
                audioEl.src = '';
                button.disabled = true;

                try {
                    // 1. Generate text phrases
                    const systemPrompt = "당신은 일본 여행자를 위한 친절한 회화 가이드입니다. 요청된 상황에 맞는 일본어 회화 3가지를 '한국어: 일본어 문장 (발음)' 형식으로만 제공해 주세요. 다른 설명은 절대 추가하지 마세요.";
                    const prompt = `지역: ${location}, 상황: ${context}`;
                    const textResult = await fetchText(prompt, systemPrompt);
                    
                    resultDiv.innerHTML = textResult.replace(/\n/g, '<br>');

                    // 2. Prepare text for TTS (removing pronunciations for cleaner audio)
                    const ttsText = textResult.replace(/\([^)]+\)/g, '').replace(/(\r\n|\n|\r)/gm, ' '); 
                    
                    // 3. Generate audio
                    const audioUrl = await fetchAudio(ttsText);
                    
                    audioEl.src = audioUrl;
                    audioContainer.classList.remove('hidden');

                } catch (error) {
                    console.error("Error generating phrase or audio:", error);
                    resultDiv.innerHTML = `<p class="text-red-600">회화 생성에 실패했습니다. (${error.message || '네트워크 오류'})</p>`;
                    audioContainer.classList.add('hidden');
                } finally {
                    button.disabled = false;
                }
            }

            async function generateSafetyTips() {
                const tipsContainer = document.getElementById('tipsResult');
                const tipsContent = document.getElementById('tipsContent');
                const generateBtn = document.getElementById('generateTipsBtn');

                tipsContainer.classList.remove('hidden');
                tipsContent.innerHTML = '<div class="flex justify-center items-center h-20"><i class="fas fa-spinner fa-spin text-[#5E548E] text-2xl"></i></div>';
                generateBtn.disabled = true;

                try {
                    const systemPrompt = "당신은 일본 오사카/교토 가족 여행 안전 전문가입니다. 가족 여행자를 위해 '교통, 식사, 긴급 상황, 기타 팁' 4가지 섹션으로 나누어 구체적인 안전 및 유의사항 팁을 마크다운 목록 형태로 한국어로만 제공해 주세요.";
                    const prompt = "오사카, 교토, 가족 여행을 위한 안전 및 유의사항 팁을 요청합니다.";
                    
                    const textResult = await fetchText(prompt, systemPrompt);
                    
                    // Simple Markdown conversion to HTML structure
                    let htmlContent = textResult
                        .split('\n')
                        .map(line => {
                            if (line.startsWith('##')) return `<h4 class="font-semibold text-lg mt-4 mb-2 text-[#5E548E]">${line.substring(2).trim()}</h4><ul class="list-disc pl-5 space-y-2">`;
                            if (line.startsWith('*') || line.startsWith('-')) return `<li>${line.substring(1).trim()}</li>`;
                            return line.trim(); // Assume other lines are wrapped by previous LLM processing
                        })
                        .join('\n');
                    
                    // Cleanup and close list if necessary
                    htmlContent = htmlContent.replace(/<\/ul>\n*<h4/g, '</ul><h4');
                    if (htmlContent.includes('<ul') && !htmlContent.endsWith('</ul>')) {
                        htmlContent += '</ul>';
                    }
                    
                    tipsContent.innerHTML = htmlContent;
                    
                } catch (error) {
                    console.error("Error generating safety tips:", error);
                    tipsContent.innerHTML = `<p class="text-red-600">안전 팁 생성에 실패했습니다. (${error.message || '네트워크 오류'})</p>`;
                } finally {
                    generateBtn.disabled = false;
                }
            }
            
            // Event listener for the Safety Tips button
            generateTipsBtn.addEventListener('click', generateSafetyTips);

            // Initial setup (Kyoto on Day 2 by default)
            updateSchedule(true);
        });
    </script>
</body>
</html>
